Размещаем свой RPM в своем репозитории
Цель: Часто в задачи администратора входит не только установка пакетов, но и сборка и поддержка собственного репозитория. Этим и займемся в ДЗ.
1) создать свой RPM (можно взять свое приложение, либо собрать к примеру апач с определенными опциями)
2) создать свой репо и разместить там свой RPM
реализовать это все либо в вагранте, либо развернуть у себя через nginx и дать ссылку на репо 

* реализовать дополнительно пакет через docker

====================================
 
[root@otuspsax vagrant]# yum install -y redhat-lsb-core wget rpmdevtools rpm-build createrepo gcc
Installed:
createrepo.noarch 0:0.9.9-28.el7           gcc.x86_64 0:4.8.5-36.el7_6.2            redhat-lsb-core.x86_64 0:4.1-27.el7.centos.1
rpm-build.x86_64 0:4.11.3-35.el7           rpmdevtools.noarch 0:8.3-5.el7           wget.x86_64 0:1.14-18.el7_6.1
Complete!

[root@otuspsax vagrant]# pwd
/home/vagrant

[root@otuspsax vagrant]# wget https://nginx.org/packages/centos/7/SRPMS/nginx-1.16.1-1.el7.ngx.src.rpm
--2019-08-29 14:10:12--  https://nginx.org/packages/centos/7/SRPMS/nginx-1.16.1-1.el7.ngx.src.rpm
Распознаётся nginx.org (nginx.org)... 95.211.80.227, 62.210.92.35, 2001:1af8:4060:a004:21::e3
Подключение к nginx.org (nginx.org)|95.211.80.227|:443... соединение установлено.
HTTP-запрос отправлен. Ожидание ответа... 200 OK
Длина: 1052448 (1,0M) [application/x-redhat-package-manager]
Сохранение в: «nginx-1.16.1-1.el7.ngx.src.rpm»

100%[===================================================================================================>] 1 052 448   1,02MB/s   за 1,0s   

2019-08-29 14:10:13 (1,02 MB/s) - «nginx-1.16.1-1.el7.ngx.src.rpm» сохранён [1052448/1052448]

[root@otuspsax vagrant]# rpm -i nginx-1.16.1-1.el7.ngx.src.rpm

[root@otuspsax vagrant]# wget https://www.openssl.org/source/latest.tar.gz
--2019-08-29 14:22:30--  https://www.openssl.org/source/latest.tar.gz
Распознаётся www.openssl.org (www.openssl.org)... 104.85.186.44, 2a02:26f0:41:688::c1e, 2a02:26f0:41:681::c1e
Подключение к www.openssl.org (www.openssl.org)|104.85.186.44|:443... соединение установлено.
HTTP-запрос отправлен. Ожидание ответа... 302 Moved Temporarily
Адрес: https://www.openssl.org/source/openssl-1.1.1c.tar.gz [переход]
--2019-08-29 14:22:31--  https://www.openssl.org/source/openssl-1.1.1c.tar.gz
Повторное использование соединения с www.openssl.org:443.
HTTP-запрос отправлен. Ожидание ответа... 200 OK
Длина: 8864262 (8,5M) [application/x-gzip]
Сохранение в: «latest.tar.gz»

100%[===================================================================================================>] 8 864 262   2,67MB/s   за 3,2s   

2019-08-29 14:22:34 (2,67 MB/s) - «latest.tar.gz» сохранён [8864262/8864262]

[root@otuspsax vagrant]# tar -xvf latest.tar.gz

[root@otuspsax vagrant]# mv openssl-1.1.1c/ /root

[root@otuspsax vagrant]# cd /root

[root@otuspsax ~]# yum-builddep rpmbuild/SPECS/nginx.spec
Installed:
  openssl-devel.x86_64 1:1.0.2k-16.el7_6.1            pcre-devel.x86_64 0:8.32-17.el7            zlib-devel.x86_64 0:1.2.7-18.el7

Complete!

[root@otuspsax ~]# vi rpmbuild/SPECS/nginx.spec

#--with-http_ssl_module
#--with-openssl=/root/openssl-1.1.1c
#убираем опцию --debug

[root@otuspsax ~]# rpmbuild -bb rpmbuild/SPECS/nginx.spec
Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.Tsz4K1
+ umask 022
+ cd /root/rpmbuild/BUILD
+ cd nginx-1.16.1
+ /usr/bin/rm -rf /root/rpmbuild/BUILDROOT/nginx-1.16.1-1.el7.ngx.x86_64
+ exit 0

[root@otuspsax ~]# ll rpmbuild/RPMS/x86_64/
total 3828
-rw-r--r--. 1 root root 2013644 авг 29 14:35 nginx-1.16.1-1.el7.ngx.x86_64.rpm
-rw-r--r--. 1 root root 1903196 авг 29 14:35 nginx-debuginfo-1.16.1-1.el7.ngx.x86_64.rpm

[root@otuspsax ~]# yum localinstall -y rpmbuild/RPMS/x86_64/nginx-1.16.1-1.el7.ngx.x86_64.rpm
Installed:
  nginx.x86_64 1:1.16.1-1.el7.ngx                                                                                                            

Complete!

[root@otuspsax ~]# systemctl start nginx

[root@otuspsax ~]# systemctl status nginx
● nginx.service - nginx - high performance web server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: disabled)
   Active: active (running) since Пт 2019-08-30 07:02:34 UTC; 7s ago
     Docs: http://nginx.org/en/docs/
  Process: 12763 ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf (code=exited, status=0/SUCCESS)
 Main PID: 12764 (nginx)
   CGroup: /system.slice/nginx.service
           ├─12764 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf
           └─12765 nginx: worker process

авг 30 07:02:34 otuspsax systemd[1]: Starting nginx - high performance web server...
авг 30 07:02:34 otuspsax systemd[1]: PID file /var/run/nginx.pid not readable (yet?) after start.
авг 30 07:02:34 otuspsax systemd[1]: Started nginx - high performance web server.

[root@otuspsax ~]# mkdir /usr/share/nginx/html/repo

[root@otuspsax ~]# cp rpmbuild/RPMS/x86_64/nginx-1.16.1-1.el7.ngx.x86_64.rpm /usr/share/nginx/html/repo 

[root@otuspsax ~]# wget https://www.percona.com/redir/downloads/percona-release/redhat/0.1-6/percona-release-0.1-6.noarch.rpm -O /usr/share/nginx/html/repo/percona-release-0.1-6.noarch.rpm
--2019-08-30 07:03:58--  https://www.percona.com/redir/downloads/percona-release/redhat/0.1-6/percona-release-0.1-6.noarch.rpm
Распознаётся www.percona.com (www.percona.com)... 74.121.199.234
Подключение к www.percona.com (www.percona.com)|74.121.199.234|:443... соединение установлено.
HTTP-запрос отправлен. Ожидание ответа... 200 OK
Длина: 14520 (14K) [application/x-redhat-package-manager]
Сохранение в: «/usr/share/nginx/html/repo/percona-release-0.1-6.noarch.rpm»

100%[===================================================================================================>] 14 520      91,4KB/s   за 0,2s   

2019-08-30 07:03:59 (91,4 KB/s) - «/usr/share/nginx/html/repo/percona-release-0.1-6.noarch.rpm» сохранён [14520/14520]

[root@otuspsax ~]# createrepo /usr/share/nginx/html/repo
Spawning worker 0 with 2 pkgs
Workers Finished
Saving Primary metadata
Saving file lists metadata
Saving other metadata
Generating sqlite DBs
Sqlite DBs complete

[root@otuspsax ~]# vi /etc/nginx/conf.d/default.conf

[root@otuspsax ~]# nginx -t
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful

[root@otuspsax ~]# nginx -s reload

[root@otuspsax ~]# curl -a http://localhost/repo/
<html>
<head><title>Index of /repo/</title></head>
<body>
<h1>Index of /repo/</h1><hr><pre><a href="../">../</a>
<a href="repodata/">repodata/</a>                                          30-Aug-2019 07:04                   -
<a href="nginx-1.16.1-1.el7.ngx.x86_64.rpm">nginx-1.16.1-1.el7.ngx.x86_64.rpm</a>                  30-Aug-2019 07:03             2013644
<a href="percona-release-0.1-6.noarch.rpm">percona-release-0.1-6.noarch.rpm</a>                   13-Jun-2018 06:34               14520
</pre><hr></body>
</html>

[root@otuspsax ~]# cat >> /etc/yum.repos.d/otus.repo << EOF
>[otus]
> name=otus-linux
> baseurl=http://localhost/repo
> gpgcheck=0
> enabled=1
> EOF

[root@otuspsax ~]# yum repolist enabled | grep otus
otus                                otus-linux                                 2

[root@otuspsax ~]# yum list | grep otus
percona-release.noarch                      0.1-6                      otus     

[root@otuspsax ~]# yum list | grep nginx
nginx.x86_64                                1:1.16.1-1.el7.ngx         installed
pcp-pmda-nginx.x86_64                       4.1.0-5.el7_6              updates  



*dz

CT-83df5203 /# cat /proc/version 
Linux version 3.10.0 (mockbuild@builder5.eng.sw.ru) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-4) (GCC) ) #1 SMP Mon Nov 7 18:22:08 MSK 2016

CT-83df5203 /# yum install docker
Installed:
  docker.x86_64 2:1.13.1-102.git7f2769b.el7.centos                                                                                                                                                          

Dependency Installed:
  PyYAML.x86_64 0:3.10-11.el7                                               atomic-registries.x86_64 1:1.22.1-26.gitb507039.el7.centos      container-storage-setup.noarch 0:0.11.0-2.git5eaf76c.el7       
  containers-common.x86_64 1:0.1.37-1.el7.centos                            device-mapper-event.x86_64 7:1.02.149-10.el7_6.8                device-mapper-event-libs.x86_64 7:1.02.149-10.el7_6.8          
  device-mapper-persistent-data.x86_64 0:0.7.3-3.el7                        docker-client.x86_64 2:1.13.1-102.git7f2769b.el7.centos         docker-common.x86_64 2:1.13.1-102.git7f2769b.el7.centos        
  libyaml.x86_64 0:0.1.4-11.el7_0                                           lvm2.x86_64 7:2.02.180-10.el7_6.8                               lvm2-libs.x86_64 7:2.02.180-10.el7_6.8                         
  oci-register-machine.x86_64 1:0-6.git2b44233.el7                          oci-systemd-hook.x86_64 1:0.2.0-1.git05e6923.el7_6              oci-umount.x86_64 2:2.5-1.el7_6                                
  parted.x86_64 0:3.1-29.el7                                                python-backports.x86_64 0:1.0-8.el7                             python-backports-ssl_match_hostname.noarch 0:3.5.0.1-1.el7     
  python-ipaddress.noarch 0:1.0.16-2.el7                                    python-pytoml.noarch 0:0.1.14-1.git7dea353.el7                  python-setuptools.noarch 0:0.9.8-7.el7                         
  subscription-manager-rhsm-certificates.x86_64 0:1.21.10-3.el7.centos      xfsprogs.x86_64 0:4.5.0-19.el7_6                                yajl.x86_64 0:2.0.4-4.el7                                      

Dependency Updated:
  device-mapper.x86_64 7:1.02.149-10.el7_6.8                                                         device-mapper-libs.x86_64 7:1.02.149-10.el7_6.8                                                        

Complete!


CT-83df5203 /# systemctl start docker

CT-83df5203 /# systemctl status docker
● docker.service - Docker Application Container Engine
   Loaded: loaded (/usr/lib/systemd/system/docker.service; disabled; vendor preset: disabled)
  Drop-In: /etc/systemd/system/docker.service.d
           └─firewalld.conf
   Active: active (running) since Mon 2019-09-02 10:19:16 MSK; 2s ago
     Docs: http://docs.docker.com
 Main PID: 2095 (dockerd-current)
   Memory: 21.7M
   CGroup: /system.slice/docker.service
           ├─2095 /usr/bin/dockerd-current --add-runtime docker-runc=/usr/libexec/docker/docker-runc-current --default-runtime=docker-runc --exec-opt native.cgroupdriver=systemd --userland-proxy-path=/...
           └─2105 /usr/bin/docker-containerd-current -l unix:///var/run/docker/libcontainerd/docker-containerd.sock --metrics-interval=0 --start-timeout 2m --state-dir /var/run/docker/libcontainerd/con...

Sep 02 10:19:15 dev.admin dockerd-current[2095]: time="2019-09-02T10:19:15.014603098+03:00" level=warning msg="Running modprobe nf_nat failed with message: ``, error: exit status 1"
Sep 02 10:19:15 dev.admin dockerd-current[2095]: time="2019-09-02T10:19:15.015752080+03:00" level=warning msg="Running modprobe xt_conntrack failed with message: ``, error: exit status 1"
Sep 02 10:19:15 dev.admin dockerd-current[2095]: time="2019-09-02T10:19:15.019254726+03:00" level=info msg="Firewalld running: true"
Sep 02 10:19:15 dev.admin dockerd-current[2095]: time="2019-09-02T10:19:15.883933654+03:00" level=info msg="Default bridge (docker0) is assigned with an IP address 172.17.0.0/16. Daemon op...d IP address"
Sep 02 10:19:16 dev.admin dockerd-current[2095]: time="2019-09-02T10:19:16.585666025+03:00" level=info msg="Loading containers: done."
Sep 02 10:19:16 dev.admin dockerd-current[2095]: time="2019-09-02T10:19:16.587101986+03:00" level=warning msg="Not using native diff for overlay2, this may cause degraded performance for b...later to fix"
Sep 02 10:19:16 dev.admin dockerd-current[2095]: time="2019-09-02T10:19:16.592534694+03:00" level=info msg="Daemon has completed initialization"
Sep 02 10:19:16 dev.admin dockerd-current[2095]: time="2019-09-02T10:19:16.592558414+03:00" level=info msg="Docker daemon" commit="7f2769b/1.13.1" graphdriver=overlay2 version=1.13.1
Sep 02 10:19:16 dev.admin systemd[1]: Started Docker Application Container Engine.
Sep 02 10:19:16 dev.admin dockerd-current[2095]: time="2019-09-02T10:19:16.596530597+03:00" level=info msg="API listen on /var/run/docker.sock"
Hint: Some lines were ellipsized, use -l to show in full.


CT-83df5203 /# docker run -it hello-world

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/

