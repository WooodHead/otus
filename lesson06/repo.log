Размещаем свой RPM в своем репозитории
Цель: Часто в задачи администратора входит не только установка пакетов, но и сборка и поддержка собственного репозитория. Этим и займемся в ДЗ.
1) создать свой RPM (можно взять свое приложение, либо собрать к примеру апач с определенными опциями)
2) создать свой репо и разместить там свой RPM
реализовать это все либо в вагранте, либо развернуть у себя через nginx и дать ссылку на репо 

* реализовать дополнительно пакет через docker

====================================
 
[root@otuspsax vagrant]# yum install -y redhat-lsb-core wget rpmdevtools rpm-build createrepo gcc
Installed:
createrepo.noarch 0:0.9.9-28.el7           gcc.x86_64 0:4.8.5-36.el7_6.2            redhat-lsb-core.x86_64 0:4.1-27.el7.centos.1
rpm-build.x86_64 0:4.11.3-35.el7           rpmdevtools.noarch 0:8.3-5.el7           wget.x86_64 0:1.14-18.el7_6.1
Complete!

[root@otuspsax vagrant]# pwd
/home/vagrant

[root@otuspsax vagrant]# wget https://nginx.org/packages/centos/7/SRPMS/nginx-1.16.1-1.el7.ngx.src.rpm
--2019-08-29 14:10:12--  https://nginx.org/packages/centos/7/SRPMS/nginx-1.16.1-1.el7.ngx.src.rpm
Распознаётся nginx.org (nginx.org)... 95.211.80.227, 62.210.92.35, 2001:1af8:4060:a004:21::e3
Подключение к nginx.org (nginx.org)|95.211.80.227|:443... соединение установлено.
HTTP-запрос отправлен. Ожидание ответа... 200 OK
Длина: 1052448 (1,0M) [application/x-redhat-package-manager]
Сохранение в: «nginx-1.16.1-1.el7.ngx.src.rpm»

100%[===================================================================================================>] 1 052 448   1,02MB/s   за 1,0s   

2019-08-29 14:10:13 (1,02 MB/s) - «nginx-1.16.1-1.el7.ngx.src.rpm» сохранён [1052448/1052448]

[root@otuspsax vagrant]# rpm -i nginx-1.16.1-1.el7.ngx.src.rpm

[root@otuspsax vagrant]# wget https://www.openssl.org/source/latest.tar.gz
--2019-08-29 14:22:30--  https://www.openssl.org/source/latest.tar.gz
Распознаётся www.openssl.org (www.openssl.org)... 104.85.186.44, 2a02:26f0:41:688::c1e, 2a02:26f0:41:681::c1e
Подключение к www.openssl.org (www.openssl.org)|104.85.186.44|:443... соединение установлено.
HTTP-запрос отправлен. Ожидание ответа... 302 Moved Temporarily
Адрес: https://www.openssl.org/source/openssl-1.1.1c.tar.gz [переход]
--2019-08-29 14:22:31--  https://www.openssl.org/source/openssl-1.1.1c.tar.gz
Повторное использование соединения с www.openssl.org:443.
HTTP-запрос отправлен. Ожидание ответа... 200 OK
Длина: 8864262 (8,5M) [application/x-gzip]
Сохранение в: «latest.tar.gz»

100%[===================================================================================================>] 8 864 262   2,67MB/s   за 3,2s   

2019-08-29 14:22:34 (2,67 MB/s) - «latest.tar.gz» сохранён [8864262/8864262]

[root@otuspsax vagrant]# tar -xvf latest.tar.gz

[root@otuspsax vagrant]# mv openssl-1.1.1c/ /root

[root@otuspsax vagrant]# cd /root

[root@otuspsax ~]# yum-builddep rpmbuild/SPECS/nginx.spec
Installed:
  openssl-devel.x86_64 1:1.0.2k-16.el7_6.1            pcre-devel.x86_64 0:8.32-17.el7            zlib-devel.x86_64 0:1.2.7-18.el7

Complete!

[root@otuspsax ~]# vi rpmbuild/SPECS/nginx.spec

#--with-http_ssl_module
#--with-openssl=/root/openssl-1.1.1c
#убираем опцию --debug

[root@otuspsax ~]# rpmbuild -bb rpmbuild/SPECS/nginx.spec
Executing(%clean): /bin/sh -e /var/tmp/rpm-tmp.Tsz4K1
+ umask 022
+ cd /root/rpmbuild/BUILD
+ cd nginx-1.16.1
+ /usr/bin/rm -rf /root/rpmbuild/BUILDROOT/nginx-1.16.1-1.el7.ngx.x86_64
+ exit 0

[root@otuspsax ~]# ll rpmbuild/RPMS/x86_64/
total 3828
-rw-r--r--. 1 root root 2013644 авг 29 14:35 nginx-1.16.1-1.el7.ngx.x86_64.rpm
-rw-r--r--. 1 root root 1903196 авг 29 14:35 nginx-debuginfo-1.16.1-1.el7.ngx.x86_64.rpm

[root@otuspsax ~]# yum localinstall -y rpmbuild/RPMS/x86_64/nginx-1.16.1-1.el7.ngx.x86_64.rpm
Installed:
  nginx.x86_64 1:1.16.1-1.el7.ngx                                                                                                            

Complete!

[root@otuspsax ~]# systemctl start nginx

[root@otuspsax ~]# systemctl status nginx
● nginx.service - nginx - high performance web server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: disabled)
   Active: active (running) since Пт 2019-08-30 07:02:34 UTC; 7s ago
     Docs: http://nginx.org/en/docs/
  Process: 12763 ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf (code=exited, status=0/SUCCESS)
 Main PID: 12764 (nginx)
   CGroup: /system.slice/nginx.service
           ├─12764 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf
           └─12765 nginx: worker process

авг 30 07:02:34 otuspsax systemd[1]: Starting nginx - high performance web server...
авг 30 07:02:34 otuspsax systemd[1]: PID file /var/run/nginx.pid not readable (yet?) after start.
авг 30 07:02:34 otuspsax systemd[1]: Started nginx - high performance web server.

[root@otuspsax ~]# mkdir /usr/share/nginx/html/repo

[root@otuspsax ~]# cp rpmbuild/RPMS/x86_64/nginx-1.16.1-1.el7.ngx.x86_64.rpm /usr/share/nginx/html/repo 

[root@otuspsax ~]# wget https://www.percona.com/redir/downloads/percona-release/redhat/0.1-6/percona-release-0.1-6.noarch.rpm -O /usr/share/nginx/html/repo/percona-release-0.1-6.noarch.rpm
--2019-08-30 07:03:58--  https://www.percona.com/redir/downloads/percona-release/redhat/0.1-6/percona-release-0.1-6.noarch.rpm
Распознаётся www.percona.com (www.percona.com)... 74.121.199.234
Подключение к www.percona.com (www.percona.com)|74.121.199.234|:443... соединение установлено.
HTTP-запрос отправлен. Ожидание ответа... 200 OK
Длина: 14520 (14K) [application/x-redhat-package-manager]
Сохранение в: «/usr/share/nginx/html/repo/percona-release-0.1-6.noarch.rpm»

100%[===================================================================================================>] 14 520      91,4KB/s   за 0,2s   

2019-08-30 07:03:59 (91,4 KB/s) - «/usr/share/nginx/html/repo/percona-release-0.1-6.noarch.rpm» сохранён [14520/14520]

[root@otuspsax ~]# createrepo /usr/share/nginx/html/repo
Spawning worker 0 with 2 pkgs
Workers Finished
Saving Primary metadata
Saving file lists metadata
Saving other metadata
Generating sqlite DBs
Sqlite DBs complete

[root@otuspsax ~]# vi /etc/nginx/conf.d/default.conf

[root@otuspsax ~]# nginx -t
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful

[root@otuspsax ~]# nginx -s reload

[root@otuspsax ~]# curl -a http://localhost/repo/
<html>
<head><title>Index of /repo/</title></head>
<body>
<h1>Index of /repo/</h1><hr><pre><a href="../">../</a>
<a href="repodata/">repodata/</a>                                          30-Aug-2019 07:04                   -
<a href="nginx-1.16.1-1.el7.ngx.x86_64.rpm">nginx-1.16.1-1.el7.ngx.x86_64.rpm</a>                  30-Aug-2019 07:03             2013644
<a href="percona-release-0.1-6.noarch.rpm">percona-release-0.1-6.noarch.rpm</a>                   13-Jun-2018 06:34               14520
</pre><hr></body>
</html>

[root@otuspsax ~]# cat >> /etc/yum.repos.d/otus.repo << EOF
>[otus]
> name=otus-linux
> baseurl=http://localhost/repo
> gpgcheck=0
> enabled=1
> EOF

[root@otuspsax ~]# yum repolist enabled | grep otus
otus                                otus-linux                                 2

[root@otuspsax ~]# yum list | grep otus
percona-release.noarch                      0.1-6                      otus     

[root@otuspsax ~]# yum list | grep nginx
nginx.x86_64                                1:1.16.1-1.el7.ngx         installed
pcp-pmda-nginx.x86_64                       4.1.0-5.el7_6              updates  



*dz

CT-83df5203 /# cat /proc/version 
Linux version 3.10.0 (mockbuild@builder5.eng.sw.ru) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-4) (GCC) ) #1 SMP Mon Nov 7 18:22:08 MSK 2016

CT-83df5203 /# curl -fsSL https://get.docker.com/ | sh
# Executing docker install script, commit: 6bf300318ebaab958c4adc341a8c7bb9f3a54a1a
+ sh -c 'yum install -y -q yum-utils'
warning: /var/cache/yum/x86_64/7/base/packages/python-chardet-2.2.1-1.el7_1.noarch.rpm: Header V3 RSA/SHA256 Signature, key ID f4a80eb5: NOKEY
Public key for python-chardet-2.2.1-1.el7_1.noarch.rpm is not installed
Importing GPG key 0xF4A80EB5:
 Userid     : "CentOS-7 Key (CentOS 7 Official Signing Key) <security@centos.org>"
 Fingerprint: 6341 ab27 53d7 8a78 a7c2 7bb1 24c6 a8a7 f4a8 0eb5
 Package    : centos-release-7-3.1611.el7.centos.x86_64 (installed)
 From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
+ sh -c 'yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo'
Loaded plugins: fastestmirror
adding repo from: https://download.docker.com/linux/centos/docker-ce.repo
grabbing file https://download.docker.com/linux/centos/docker-ce.repo to /etc/yum.repos.d/docker-ce.repo
repo saved to /etc/yum.repos.d/docker-ce.repo
+ '[' stable '!=' stable ']'
+ sh -c 'yum makecache'
Loaded plugins: fastestmirror
base                                                                                   | 3.6 kB  00:00:00     
docker-ce-stable                                                                       | 3.5 kB  00:00:00     
extras                                                                                 | 3.4 kB  00:00:00     
updates                                                                                | 3.4 kB  00:00:00     
(1/12): docker-ce-stable/x86_64/updateinfo                                             |   55 B  00:00:00     
(2/12): docker-ce-stable/x86_64/filelists_db                                           |  16 kB  00:00:00     
(3/12): docker-ce-stable/x86_64/primary_db                                             |  32 kB  00:00:00     
(4/12): docker-ce-stable/x86_64/other_db                                               | 112 kB  00:00:00     
(5/12): base/7/x86_64/other_db                                                         | 2.6 MB  00:00:00     
(6/12): extras/7/x86_64/prestodelta                                                    |  73 kB  00:00:00     
(7/12): base/7/x86_64/filelists_db                                                     | 7.1 MB  00:00:00     
(8/12): extras/7/x86_64/filelists_db                                                   | 249 kB  00:00:00     
(9/12): extras/7/x86_64/other_db                                                       | 131 kB  00:00:00     
(10/12): updates/7/x86_64/prestodelta                                                  | 945 kB  00:00:00     
(11/12): updates/7/x86_64/other_db                                                     | 764 kB  00:00:00     
(12/12): updates/7/x86_64/filelists_db                                                 | 5.2 MB  00:00:00     
Loading mirror speeds from cached hostfile
 * base: mirror.wiuwiu.de
 * extras: ftp.antilo.de
 * updates: mirror.checkdomain.de
Metadata Cache Created
+ '[' -n '' ']'
+ sh -c 'yum install -y -q docker-ce'
Delta RPMs disabled because /usr/bin/applydeltarpm not installed.
warning: /var/cache/yum/x86_64/7/docker-ce-stable/packages/docker-ce-19.03.1-3.el7.x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID 621e9f35: NOKEY
Public key for docker-ce-19.03.1-3.el7.x86_64.rpm is not installed
Importing GPG key 0x621E9F35:
 Userid     : "Docker Release (CE rpm) <docker@docker.com>"
 Fingerprint: 060a 61c5 1b55 8a7f 742b 77aa c52f eb6b 621e 9f35
 From       : https://download.docker.com/linux/centos/gpg
setsebool:  SELinux is disabled.
If you would like to use Docker as a non-root user, you should now consider
adding your user to the "docker" group with something like:

  sudo usermod -aG docker your-user

Remember that you will have to log out and back in for this to take effect!

WARNING: Adding a user to the "docker" group will grant the ability to run
         containers which can be used to obtain root privileges on the
         docker host.
         Refer to https://docs.docker.com/engine/security/security/#docker-daemon-attack-surface
         for more information.

CT-83df5203 /# sudo systemctl start docker

CT-83df5203 /# sudo systemctl status docker
● docker.service - Docker Application Container Engine
   Loaded: loaded (/usr/lib/systemd/system/docker.service; disabled; vendor preset: disabled)
  Drop-In: /etc/systemd/system/docker.service.d
           └─firewalld.conf
   Active: active (running) since Fri 2019-08-30 17:27:14 MSK; 27s ago
     Docs: https://docs.docker.com
 Main PID: 641 (dockerd)
   Memory: 42.2M
   CGroup: /system.slice/docker.service
           └─641 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock

Aug 30 17:27:13 dev.admin dockerd[641]: time="2019-08-30T17:27:13.028250078+03:00" level=warning msg="Running modprobe bridge br_netfilter failed with message: , error: exit status 1"
Aug 30 17:27:13 dev.admin dockerd[641]: time="2019-08-30T17:27:13.029102788+03:00" level=warning msg="Running modprobe nf_nat failed with message: ``, error: exit status 1"
Aug 30 17:27:13 dev.admin dockerd[641]: time="2019-08-30T17:27:13.029855576+03:00" level=warning msg="Running modprobe xt_conntrack failed with message: ``, error: exit status 1"
Aug 30 17:27:13 dev.admin dockerd[641]: time="2019-08-30T17:27:13.833369525+03:00" level=info msg="Default bridge (docker0) is assigned with an IP address 172.17.0.0/16. Daemon option --b...ed IP address"
Aug 30 17:27:14 dev.admin dockerd[641]: time="2019-08-30T17:27:14.332434003+03:00" level=info msg="Loading containers: done."
Aug 30 17:27:14 dev.admin dockerd[641]: time="2019-08-30T17:27:14.353655196+03:00" level=warning msg="Not using native diff for overlay2, this may cause degraded performance for building ...river=overlay2
Aug 30 17:27:14 dev.admin dockerd[641]: time="2019-08-30T17:27:14.354105485+03:00" level=info msg="Docker daemon" commit=74b1e89 graphdriver(s)=overlay2 version=19.03.1
Aug 30 17:27:14 dev.admin dockerd[641]: time="2019-08-30T17:27:14.354170020+03:00" level=info msg="Daemon has completed initialization"
Aug 30 17:27:14 dev.admin systemd[1]: Started Docker Application Container Engine.
Aug 30 17:27:14 dev.admin dockerd[641]: time="2019-08-30T17:27:14.536413528+03:00" level=info msg="API listen on /var/run/docker.sock"
Hint: Some lines were ellipsized, use -l to show in full.
